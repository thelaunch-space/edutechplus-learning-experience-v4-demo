# Voice-Based Engagement Layer for EdutechPlus Learning Experience

## Problem Statement

**Current State:** EdutechPlus B2G math content (videos + applets) designed for teacher-controlled classroom delivery on TV screens. Teacher provides engagement, guidance, and continuity.

**Target State:** B2C student-facing mobile app. Same learning assets, zero teacher dependency. Need engagement layer to maintain 20-minute continuous attention from Grade 4 students.

**Core Constraint:** Use existing assets (videos + applets) as-is. No content recreation.

---

## Solution Approach

### Voice-Based AI Companion ("Math Mate")

**Core Mechanics:**
- Two-way voice interaction at transitions between learning assets
- STT captures kid's short verbal responses (2-5 seconds)
- LLM generates contextual, encouraging one-liner responses
- TTS delivers personalized, energetic responses
- Auto-progression to next asset after interaction
- Simple fallbacks for silence or errors

**Design Principles:**
1. **Momentum Pacing:** Game-show energy, countdowns, urgency through voice tone
2. **Personal Challenge Frame:** "7 challenges in 20 minutes" creates closure motivation
3. **Prediction Micro-Bets:** Low-stakes guessing before assets creates anticipation
4. **Graceful Fallbacks:** Works even if kid stays silent or gives unexpected answers

**Why This Works:**
- Kid feels accompanied (not alone with content)
- Truly conversational responses (LLM adapts to any answer)
- Low cognitive overhead (simple yes/no or one-word answers)
- Natural pacing prevents drift between assets
- Handles unexpected answers gracefully

---

## Architecture Decision: LLM-Based Responses

**Approach:** Every Math Mate response is generated by GPT-4o-mini with guardrailed prompts, providing truly conversational and adaptive interactions.

**Key Benefits:**
- Handles any kid response naturally (not just keyword matches)
- More engaging and personal conversation flow
- Gracefully adapts to unexpected answers
- Simpler codebase (no complex keyword extraction logic)

**Trade-offs:**
- Adds 300-600ms LLM latency (acceptable for 2-2.5s total response time)
- Requires fallback for LLM timeouts (>3s)
- Slightly higher cost than pure templating (~$0.10-0.20 per 1000 sessions)

**Why This Works for Demo:**
- More impressive "wow factor" for stakeholders
- Demonstrates true AI conversation capability
- Cost is minimal for demo scale
- Can optimize latency in production if needed

---

## Tech Stack

### Frontend
- **Framework:** React (mobile web app)
- **Video Player:** HTML5 video element or React Player
- **Applet Integration:** iFrame embedding of existing HTML applets

### Voice Interaction
- **STT (Speech-to-Text):**
  - Deepgram (real-time, ~300ms latency, better for kid speech)
  - Fallback: Web Speech API (browser-based, free but less accurate)

- **TTS (Text-to-Speech):**
  - Deepgram Aura TTS API (primary)
  - Voice: `aura-asteria-en` (warm, friendly female voice for kids)
  - Fallback: Browser Web Speech API (if Deepgram unavailable)
  - Latency: 500-1000ms
  - Cost: ~$0.59/1M characters (~$0.30-0.50 per 1000 sessions)

- **Response Generation:**
  - OpenRouter GPT-4.1-nano with guardrailed prompts for contextual one-liner responses
  - System prompt enforces: max 15 words, simple English (Asian kids), encouraging tone
  - Latency: 300-600ms
  - Fallback: If LLM times out (>3s) or kid silent → "Great! Let's continue!"

### Infrastructure
- **Hosting:** Netlify  (React app)
- **Audio Processing:** Browser AudioContext API for recording
- **State Management:** React Context or Zustand (track progress, name, interaction history)

---

## Interaction Flow Architecture

### Session Structure

```
[Session Start]
  ↓
[Name Capture + Challenge Introduction]
  ↓
[Asset 1: Video 1]
  ↓
[Voice Interaction 1]
  ↓
[Asset 2: Applet A1]
  ↓
[Voice Interaction 2]
  ↓
... (repeat for 7 assets)
  ↓
[Celebration + Session End]
```

### Interaction Pattern (Repeated 7 Times)

```
1. Math Mate asks question (TTS, 500-1000ms)
2. Listening window opens (5 seconds)
3. Kid responds verbally (STT captures, 300-800ms)
4. LLM generates contextual response (GPT-4o-mini, 300-600ms)
5. Math Mate responds (TTS, 500-1000ms)
6. Brief pause (1 second)
7. Auto-load next asset
```

**Total Interaction Time per Transition:** 10-15 seconds (includes 2-2.5s processing)
**Total Interaction Time for 7 Transitions:** ~2-3 minutes
**Content Time:** 16.9 minutes (videos + applets)
**Total Session:** ~20 minutes

---

## Full Interaction Map: Fractions Module

### Pre-Module (Onboarding)

**Math Mate (TTS):** "Hi! I'm Math Mate. What's your name?"

**Kid (STT):** [responds verbally or stays silent]

**Math Mate (TTS):** [LLM generates personalized greeting]
- If name captured: "Great, [NAME]! We have 7 challenges today. Can you finish in 20 minutes? Say yes or let's go!"
- If silent: "That's okay! I'll call you Friend. We have 7 challenges. Say yes or let's go!"

**Kid (STT):** [responds verbally or stays silent]

**Math Mate (TTS):** "Awesome! Challenge 1 starting in 3...2...1...GO!"

---

### Asset 1: Video 1 (Foundation Concepts)
**Duration:** 2.5 minutes
**File:** `videos/video-1.mp4`

**Post-Video Interaction:**

**Math Mate:** "What food did you see in the video? Pizza, cake, or something else? Just say one!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response based on kid's answer]
- Example responses: "Great! Pizza! Fractions are in food! Challenge 1 done!"
- Or: "Chocolate! Good! I saw that too! Challenge 1 done!"
- Or: "Yes! Cake! Good memory! Challenge 1 done!"
- If silent: "That's okay! Let's keep going. Challenge 1 done!"

**Math Mate:** "Challenge 2 starting now!"

---

### Asset 2: Applet A1 (Cut & Glue Practice)
**Duration:** 4 minutes
**Path:** `applets/A1. M2-Fraction Cut and Glue Practice/index.html`

**Pre-Applet:**
**Math Mate:** "Now you'll cut paper into fractions. Try to make equal parts!"

**Post-Applet Interaction:**

**Math Mate:** "How many pieces did you make? Just say a number!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response]
- Example: "Four pieces! Good! That's a fraction! Challenge 2 done!"
- Or: "Nice! I saw those pieces! Challenge 2 done!"
- If silent: "That's okay! Let's see more. Challenge 2 done!"

**Math Mate:** "Challenge 3 coming up!"

---

### Asset 3: Applet A2 (Paper Cut Snapshot)
**Duration:** 2 minutes
**Path:** `applets/A2.M2-Fraction Paper Cut Snapshot/index.html`

**Pre-Applet:**
**Math Mate:** "Watch how fractions change from 1/2 to 1/4 to 1/6. Pay attention!"

**Post-Applet Interaction:**

**Math Mate:** "Which has MORE pieces—1/4 or 1/6? Just say one!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response with fractions context]
- Example (correct): "Correct! 1/6 has more pieces! Challenge 3 done!"
- Example (incorrect): "Almost! It's 1/6. Tricky! Challenge 3 done!"
- Example (unclear): "Good try! It's 1/6—more parts! Challenge 3 done!"
- If silent: "That's okay! 1/6 has more parts. Challenge 3 done!"

**Math Mate:** "Halfway there! Challenge 4 next!"

---

### Asset 4: Applet A3 (Statement Cake)
**Duration:** 3 minutes
**Path:** `applets/A3. M2-Fraction Statement Cake Snapshot/index.html`

**Pre-Applet:**
**Math Mate:** "Time to learn fraction vocabulary with a cake story. Watch closely!"

**Post-Applet Interaction:**

**Math Mate:** "What did the cake teach you about? Equal parts, numerator, or something else? Just guess!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response]
- Example: "Yes! Equal parts! Very good! Challenge 4 done!"
- Or: "Numerator! Good! That's the top number! Challenge 4 done!"
- If silent: "That's okay! Equal parts mean same size. Challenge 4 done!"

**Math Mate:** "You're doing great, [NAME]! Challenge 5 starting!"

---

### Asset 5: Video 2 (Advanced Concepts)
**Duration:** 1.9 minutes
**File:** `videos/video-2.mp4`

**Pre-Video:**
**Math Mate:** "Now we'll make fractions like 2/4 and 3/6. The top number can be more than 1!"

**Post-Video Interaction:**

**Math Mate:** "Quick! Can the top number be 2 or 3? Say yes or no!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response]
- Example (correct): "Correct! Top number can be any number! Challenge 5 done!"
- Example (incorrect): "Yes! Top can be 2, 3, or more! Challenge 5 done!"
- If silent: "That's okay! It can be 2 or 3! Challenge 5 done!"

**Math Mate:** "Almost finished! Challenge 6 loading!"

---

### Asset 6: Applet A4 (Cut & Glue Practice 2)
**Duration:** 3 minutes
**Path:** `applets/A4.M2-Fraction Cut and Glue Practice 2/index.html`

**Pre-Applet:**
**Math Mate:** "Now make fractions with bigger top numbers. Try 2/5 or 3/5!"

**Post-Applet Interaction:**

**Math Mate:** "What fraction did you make? Say the top number and bottom number!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual response]
- Example: "Great! 2 and 5! You're a fraction expert! Challenge 6 done!"
- Or: "Good job! You made a fraction! Challenge 6 done!"
- If silent: "That's okay! You did well. Challenge 6 done!"

**Math Mate:** "Last challenge! Challenge 7 starting!"

---

### Asset 7: Video 3 (Mastery Culmination)
**Duration:** 30 seconds
**File:** `videos/video-3.mp4`

**Pre-Video:**
**Math Mate:** "You've learned so much, [NAME]! Watch this final message!"

**Post-Video Interaction:**

**Math Mate:** "You finished all 7 challenges! You're a fraction master now! Say bye or see you!"

**Kid:** [responds verbally - any answer]

**Math Mate:** [LLM generates contextual closing response]
- Example: "Bye [NAME]! Good job today!"
- Or: "See you [NAME]! You learned fractions!"
- If silent: "See you next time, [NAME]! You did great!"

**[Session ends with celebration animation/sound]**

---

## Technical Implementation Notes

### LLM Response Generation Strategy

**System Prompt Template:**
```javascript
const systemPrompt = `You are Math Mate, an encouraging AI companion for Grade 4 students learning fractions.

CRITICAL RULES:
1. Generate EXACTLY ONE sentence (max 15 words)
2. Use VERY simple English (for Asian kids, English is second language)
3. Use short, common words only (avoid: sophisticated, complex, fancy words)
4. Always be positive and encouraging
5. End with "Challenge {challengeNum} done!" if this completes a challenge
6. If student is wrong, gently correct with simple words
7. Reference the student's answer when possible

LANGUAGE GUIDELINES:
- Good: "Great! Pizza! Fractions are in our food!"
- Bad: "Excellent observation! Pizza is an outstanding example of fractions!"
- Good: "Yes! Equal parts!"
- Bad: "Precisely! Equal portions are fundamental!"

Context:
- Current Asset: {assetName}
- Question Asked: {question}
- Student Response: {studentResponse}
- Student Name: {studentName}
- Challenge Number: {challengeNum}
`;
```

**Example LLM Calls:**
```javascript
// Asset 1: Food question
const response = await openai.chat.completions.create({
  model: "gpt-4o-mini",
  messages: [
    { role: "system", content: systemPrompt },
    { role: "user", content: "Student said: 'pizza'" }
  ],
  max_tokens: 25,
  temperature: 0.7
});

// Expected: "Great! Pizza! Fractions are in food! Challenge 1 done!"
```

**Fallback Strategy:**
- If LLM timeout (>3s): "Great! Let's continue!"
- If kid silent: Use predefined encouraging phrase
- If STT fails: "That's okay! Let's keep going!"

### State Management

**Session State Schema:**
```javascript
{
  studentName: string | "Friend",
  currentAsset: number, // 0-6
  completedAssets: number,
  interactionHistory: [
    { asset: number, question: string, response: string, timestamp: Date }
  ],
  startTime: Date,
  endTime: Date | null
}
```

---

## Performance Optimization

### Latency Reduction Strategies

1. **Streaming TTS:**
   - Use OpenAI TTS streaming API
   - Start playback as soon as first audio chunk arrives
   - Perceived latency: <1 second

2. **Parallel Processing:**
   - Pre-load next asset while LLM + TTS are processing
   - Process STT and start LLM call simultaneously when possible

3. **LLM Optimization:**
   - Use max_tokens=25 to limit response length (max 15 words)
   - Temperature=0.7 for consistent, fast responses
   - Set timeout at 3 seconds for graceful fallback

4. **Pre-cache Common Phrases:**
   - Pre-generate TTS for fallback phrases ("Great! Let's continue!")
   - Store in IndexedDB for instant playback

5. **Fallback Degradation:**
   - If LLM timeout (>3s) → use cached fallback immediately
   - If STT fails → use silence fallback
   - Never block progression

---

## Success Metrics

**Primary KPI:** Session completion rate (% of students who finish all 7 assets)

**Secondary KPIs:**
- Average session duration (target: 18-22 minutes)
- Voice interaction success rate (% of non-silent responses)
- Drop-off points (which asset causes most exits)

**Qualitative:** Post-session parent/kid feedback on "Did it feel engaging?"

---

## Cost Estimate (Per 1000 Sessions)

**Assumptions:** 7 interactions per session, ~30 seconds total audio per session, ~100 words of LLM responses per session

- **STT:** $0.25-0.50 (Deepgram: ~$0.0048/min for 3.5 min total listening)
- **TTS:** $0.30-0.50 (Deepgram Aura: ~$0.59/1M chars, ~500 chars per session)
- **LLM:** $0.10-0.20 (OpenRouter GPT-4.1-nano: $0.15/1M input + $0.60/1M output tokens)

**Total per 1000 sessions:** $0.65-1.20

**Cost Breakdown:**
- STT: ~35%
- TTS: ~40%
- LLM: ~25%

**Note:** This is significantly cheaper than the original ElevenLabs approach ($2-4/1000 sessions) while providing truly conversational responses.

---

## Bugs Fixed During Development

### Bug 1: Duplicate Greeting Message
**Issue:** Math Mate said the greeting "Hi! I'm Math Mate, your friend! What's your name?" twice - once during GREETING phase (correct) and again during PRE_CHALLENGE phase (incorrect).

**Root Cause:** Challenge #1's `preScript` in `src/config/challenges.ts` was hardcoded to the greeting text instead of an introduction to the first video. When the app transitioned to PRE_CHALLENGE, it spoke the challenge's preScript, which was the greeting.

**Solution:** Updated `challenges.ts` line 11 to use contextually appropriate pre-script for each challenge:
```typescript
// Before (wrong):
preScript: "Hi! I'm Math Mate, your friend! What's your name?",

// After (correct):
preScript: "Let's start our first challenge! Watch this video about fractions.",
```

---

### Bug 2: App Not Advancing After Post-Challenge
**Issue:** After the student answered the post-challenge question and Math Mate responded, the app got stuck and did not advance to the next challenge.

**Root Cause:** The `goToNextChallenge()` function in `useSessionStore.ts` was setting both `currentChallengeIndex` AND `phase` atomically in a single Zustand update. Due to React's rendering behavior with async functions, the state change wasn't reliably triggering the useEffect that starts the next pre-challenge phase.

**Solution:** Separated concerns - `goToNextChallenge()` now only updates `currentChallengeIndex` and returns a boolean. Explicit phase setting happens in `useVoiceInteraction.ts`:

**Changes in `src/store/sessionStore.ts` (lines 49-57):**
```typescript
// Before:
goToNextChallenge: () => set((state) => { ... /* atomic update */ }),

// After:
goToNextChallenge: () => {
  const state = get();
  const nextIndex = state.currentChallengeIndex + 1;
  const isComplete = nextIndex >= state.challenges.length;
  if (!isComplete) {
    set({ currentChallengeIndex: nextIndex });
  }
  return isComplete;
},
```

**Changes in `src/hooks/useVoiceInteraction.ts` (lines 246-254):**
```typescript
// Explicitly set phase after advancing
const isComplete = goToNextChallenge();
if (isComplete) {
  setPhase('COMPLETE');
} else {
  setPhase('PRE_CHALLENGE');
}
```

---

### Bug 3: Premature "Challenge X Done!" in Greeting
**Issue:** When Math Mate greeted the student, it said "Hi Gautam! We have 7 fun challenges today. Let's start and have fun! Challenge 1 done!" - the "Challenge 1 done!" was inappropriate since no challenge had been completed yet.

**Root Cause:** The `MATH_MATE_SYSTEM_PROMPT` in `src/config/prompts.ts` contained the rule: "End with 'Challenge {challengeNum} done!' if completing a challenge". This rule was included in ALL LLM calls, including the greeting. The LLM incorrectly applied this rule during the welcome message.

**Solution:** Created a separate greeting-specific system prompt without the "challenge done" rule.

**Changes in `src/config/prompts.ts` (lines 39-49):**
```typescript
export const GREETING_SYSTEM_PROMPT = `You are Math Mate, an encouraging AI tutor for Grade 4 students learning fractions.

RULES FOR THIS GREETING:
1. Generate EXACTLY ONE sentence (max 15 words)
2. Use VERY simple English (for Asian kids, English is second language)
3. Welcome the student by name
4. Tell them we have 7 fun challenges today
5. Be excited and warm
6. Do NOT mention anything about challenges being "done" - we haven't started yet!

EXAMPLE: "Hi Maya! We have 7 fun challenges today. Let's go!"`;
```

**Changes in `src/services/openrouter.ts` (line 104):**
Used `GREETING_SYSTEM_PROMPT` instead of `MATH_MATE_SYSTEM_PROMPT` in the greeting generation function.

---

## Open Questions

1. **Voice Gender/Accent:** Should Math Mate sound male, female, or neutral? Indonesian accent or neutral English?
2. **Background Music:** Should there be ambient music during interactions or pure silence?
3. **Retry Logic:** If kid gives completely off-topic answer, do we retry the question or move on?
4. **Parental Controls:** Should parents have a dashboard to monitor progress?

---

*Document Version: 2.0*
*Last Updated: 2026-01-09*
*Author: Krishna Goutham (thelaunch.space)*
*Architecture: LLM-based conversational responses with OpenAI TTS*
